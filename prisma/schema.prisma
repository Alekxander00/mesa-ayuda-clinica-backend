// prisma/schema.prisma - CORREGIDO
generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  user
  technician
  admin
  auditor
}

enum TicketStatus {
  open
  pending
  in_progress
  resolved
  closed
}

enum NotificationType {
  email
  inapp
}

model User {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String   @unique
  email_verified  Boolean  @default(false)
  password_hash   String
  name            String?
  role            UserRole @default(user)
  created_at      DateTime @default(now()) @db.Timestamptz
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamptz

  // Relaciones
  reported_tickets Ticket[]           @relation("ReportedTickets")
  assigned_tickets Ticket[]           @relation("AssignedTickets")
  sent_messages    TicketMessage[]    @relation("MessageSender")
  attachments      Attachment[]       @relation("AttachmentUploader")
  notifications    Notification[]     @relation("NotificationUser")
  audit_logs       AuditLog[]         @relation("AuditLogActor")
  
  // RELACIÓN CORREGIDA: Solo referencia, sin fields/arguments
  authorized_email AuthorizedEmail?

  @@map("users")
}

// NUEVO MODELO: Correos autorizados - RELACIÓN CORREGIDA
model AuthorizedEmail {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String   @unique
  allowed_role UserRole @default(user)
  created_at   DateTime @default(now()) @db.Timestamptz

  // RELACIÓN CORREGIDA: Solo un lado tiene fields/references
  user         User?    @relation(fields: [email], references: [email])

  @@map("authorized_emails")
}

model Module {
  id    Int    @id
  key   String @unique
  label String

  tickets Ticket[] @relation("ModuleTickets")

  @@map("modules")
}

model TicketType {
  id    Int    @id
  key   String @unique
  label String

  tickets Ticket[] @relation("TypeTickets")

  @@map("ticket_types")
}

model Ticket {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code           String       @unique
  user_id        String       @db.Uuid
  module_id      Int
  ticket_type_id Int
  subject        String?
  description    String
  status         TicketStatus @default(open)
  assigned_to    String?      @db.Uuid
  priority       Int?
  created_at     DateTime     @default(now()) @db.Timestamptz
  updated_at     DateTime     @default(now()) @updatedAt @db.Timestamptz

  // Relaciones
  user           User        @relation("ReportedTickets", fields: [user_id], references: [id])
  module         Module      @relation("ModuleTickets", fields: [module_id], references: [id])
  ticket_type    TicketType  @relation("TypeTickets", fields: [ticket_type_id], references: [id])
  assigned_to_user User?     @relation("AssignedTickets", fields: [assigned_to], references: [id])
  messages       TicketMessage[] @relation("TicketMessages")
  attachments    Attachment[]    @relation("TicketAttachments")
  notifications  Notification[]  @relation("TicketNotifications")

  @@map("tickets")
}

model TicketMessage {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticket_id  String   @db.Uuid
  sender_id  String   @db.Uuid
  body       String
  is_internal Boolean @default(false)
  created_at DateTime @default(now()) @db.Timestamptz

  // Relaciones
  ticket Ticket @relation("TicketMessages", fields: [ticket_id], references: [id], onDelete: Cascade)
  sender User   @relation("MessageSender", fields: [sender_id], references: [id], onDelete: Cascade)
  attachments Attachment[] @relation("MessageAttachments")

  @@map("ticket_messages")
}

model Attachment {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticket_id    String?  @db.Uuid
  message_id   String?  @db.Uuid
  filename     String
  mime_type    String
  size_bytes   BigInt
  storage_path String
  uploaded_by  String   @db.Uuid
  created_at   DateTime @default(now()) @db.Timestamptz

  // Relaciones
  ticket    Ticket?        @relation("TicketAttachments", fields: [ticket_id], references: [id], onDelete: Cascade)
  message   TicketMessage? @relation("MessageAttachments", fields: [message_id], references: [id], onDelete: Cascade)
  uploader  User           @relation("AttachmentUploader", fields: [uploaded_by], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model Notification {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String           @db.Uuid
  ticket_id   String           @db.Uuid
  type        NotificationType
  delivered   Boolean          @default(false)
  delivered_at DateTime?       @db.Timestamptz
  created_at  DateTime         @default(now()) @db.Timestamptz

  // Relaciones
  user   User   @relation("NotificationUser", fields: [user_id], references: [id], onDelete: Cascade)
  ticket Ticket @relation("TicketNotifications", fields: [ticket_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actor_id   String   @db.Uuid
  action     String
  details    Json?
  created_at DateTime @default(now()) @db.Timestamptz

  // Relación
  actor User @relation("AuditLogActor", fields: [actor_id], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}